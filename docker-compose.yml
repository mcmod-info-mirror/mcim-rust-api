x-mcim-rust-api-logging: &mcim-rust-api-loki-logging
  driver: loki
  options:
    loki-url: "http://localhost:3100/loki/api/v1/push"
    max-size: "20m"
    max-file: "3"
    keep-file: "true"
    loki-pipeline-stages: |
      - regex:
          expression: '^\[(?P<time>[^ ]+) (?P<level>[A-Z]+)[^\]]*\] (?P<message>.*)'

      - labels:
          level:
      - match:
          selector: '{level="INFO"}'
          stages:
            - regex:
                source: "message"
                expression: '^(?P<ip>\S+) "(?P<method>\S+) (?P<path>\S+) (?P<protocol>[^"]+)" "(?P<url_template>[^"]+)" (?P<status>\d+) "(?P<referer>[^"]*)" "(?P<user_agent>[^"]+)" (?P<duration_ms>[\d.]+) ms'
            - labels:
                method:
                status:
                referer:
                user_agent:
                url_template:
                ip:

x-mongo-logging: &mongo-loki-logging
  driver: loki
  options:
    loki-url: "http://localhost:3100/loki/api/v1/push"
    max-size: "20m"
    max-file: "3"
    keep-file: "true"
    loki-pipeline-stages: |
      - json:
          expressions:
            level: record.level.name

      - labels:
          level: level

x-redis-logging: &redis-loki-logging
  driver: loki
  options:
    loki-url: "http://localhost:3100/loki/api/v1/push"
    max-size: "20m"
    max-file: "3"
    keep-file: "true"

services:
  mongodb:
    container_name: mongo
    image: mongo:latest
    restart: always
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    volumes:
      - /data/db:/data/db
      - ./config/mongod.conf:/etc/mongod.conf

    command:
      - "--bind_ip_all"
    logging: *mongo-loki-logging
    deploy:
      resources:
        limits:
          memory: 400M
        reservations:
          memory: 200M

  redis:
    container_name: redis
    image: redis:alpine
    ports:
      - 6379:6379
    restart: always
    logging: *redis-loki-logging
    volumes: 
      - ./config/redis.conf:/etc/redis/redis.conf
    command: redis-server /etc/redis/redis.conf
    deploy:
      resources:
        limits:
          memory: 300M
        reservations:
          memory: 200M

  mcim-rust-api:
    container_name: mcim-rust-api
    image: z0z0r4/mcim-rust-api:latest
    ports:
      - 8080:8080
    restart: always
    depends_on:
      - mongodb
      - redis
    environment:
      PORT: 8080
      MONGODB_URI: "mongodb://root:example@mongodb:27017"
      REDIS_URL: "redis://redis:6379"
      CURSEFORGE_API_URL: "https://api.curseforge.com"
      MODRINTH_API_URL: "https://api.modrinth.com"
      CURSEFORGE_API_KEY: "your_curseforge_api_key"
    logging: *mcim-rust-api-loki-logging
    deploy:
      resources:
        limits:
          memory: 500M
        reservations:
          memory: 300M